<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ampertech — Estoque & Vendas</title>
  <meta name="theme-color" content="#f5f7fb" />
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:rgba(15,23,42,.12);

      --ok:#16a34a;
      --info:#0284c7;
      --warn:#d97706;
      --danger:#e11d48;

      --shadow: 0 10px 28px rgba(2,6,23,.10);
      --r:18px;
      --r2:14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(2,132,199,.10), transparent 55%),
        radial-gradient(1000px 500px at 100% 0%, rgba(22,163,74,.10), transparent 55%),
        var(--bg);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:16px 12px 90px}
    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:8px 4px 14px;
      flex-wrap:wrap;
    }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: linear-gradient(135deg, rgba(2,132,199,.18), rgba(22,163,74,.16));
      border:1px solid rgba(15,23,42,.10);
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      font-weight:900;
      letter-spacing:.5px;
      color:#0f172a;
    }
    .title b{font-size:15px}
    .title small{display:block; margin-top:2px; color:var(--muted); font-size:12px}

    .btn{
      border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.85);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      display:inline-flex; align-items:center; gap:8px;
      transition:.12s ease;
      box-shadow: 0 6px 16px rgba(2,6,23,.08);
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); background:#fff}
    .btn:active{transform:translateY(0)}
    .btn.primary{border-color:rgba(22,163,74,.30); background:rgba(22,163,74,.10)}
    .btn.info{border-color:rgba(2,132,199,.30); background:rgba(2,132,199,.10)}
    .btn.danger{border-color:rgba(225,29,72,.25); background:rgba(225,29,72,.08)}

    .card{
      background: var(--card);
      border:1px solid rgba(15,23,42,.10);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:14px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(2,132,199,.06), transparent);
    }
    .hd h2{margin:0; font-size:14px}
    .hd p{margin:4px 0 0; font-size:12px; color:var(--muted); line-height:1.35}
    .bd{padding:14px}

    .kpis{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:10px}
    @media(max-width:900px){ .kpis{grid-template-columns:repeat(2,minmax(0,1fr))} }
    .kpi{
      border:1px solid rgba(15,23,42,.08);
      background: rgba(2,132,199,.04);
      border-radius: var(--r2);
      padding:12px;
    }
    .kpi small{color:var(--muted); font-weight:900; letter-spacing:.2px}
    .kpi b{display:block; margin-top:6px; font-size:18px}

    .tabs{display:flex; gap:10px; flex-wrap:wrap}
    .tab{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.85);
      cursor:pointer;
      font-weight:900;
      font-size:13px;
    }
    .tab.active{border-color:rgba(2,132,199,.35); background:rgba(2,132,199,.10)}

    .grid{display:grid; grid-template-columns:1.05fr .95fr; gap:12px}
    @media(max-width:980px){ .grid{grid-template-columns:1fr} }

    label{font-size:11px; color:var(--muted); font-weight:900; letter-spacing:.2px}
    input, select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      color:var(--text);
      padding:10px 11px;
      font-size:13px;
      outline:none;
    }
    input:focus, select:focus{
      border-color: rgba(2,132,199,.45);
      box-shadow: 0 0 0 3px rgba(2,132,199,.12);
    }
    .row{display:grid; grid-template-columns:repeat(12,1fr); gap:10px; align-items:end}
    .field{grid-column:span 3; display:flex; flex-direction:column; gap:6px}
    .span2{grid-column:span 2}
    .span3{grid-column:span 3}
    .span4{grid-column:span 4}
    .span5{grid-column:span 5}
    .span6{grid-column:span 6}
    .span7{grid-column:span 7}
    .span12{grid-column:span 12}

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border:1px solid rgba(15,23,42,.10);
      border-radius:16px;
      overflow:hidden;
      background: #fff;
    }
    .table th,.table td{
      padding:10px;
      font-size:12px;
      border-bottom:1px solid rgba(15,23,42,.08);
      text-align:left;
      white-space:nowrap;
      vertical-align:middle;
    }
    .table th{
      font-size:11px;
      color:var(--muted);
      font-weight:900;
      background: rgba(2,132,199,.06);
      position:sticky; top:0;
      z-index:1;
    }
    .table tr:hover td{background: rgba(2,132,199,.04)}
    .muted{color:var(--muted)}

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(15,23,42,.04);
      font-weight:900;
      font-size:11px;
    }
    .pill.ok{border-color:rgba(22,163,74,.30); background:rgba(22,163,74,.10)}
    .pill.low{border-color:rgba(217,119,6,.28); background:rgba(217,119,6,.10)}
    .pill.zero{border-color:rgba(225,29,72,.22); background:rgba(225,29,72,.08)}
    .hr{height:1px; background:var(--line); margin:12px 0}

    .toast{
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background: rgba(255,255,255,.95);
      border:1px solid rgba(15,23,42,.14);
      padding:10px 12px;
      border-radius:999px;
      box-shadow: var(--shadow);
      display:none;
      font-size:12px;
      font-weight:900;
      z-index:40;
    }
    .toast.show{display:block}
    .hide{display:none !important}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">AT</div>
        <div class="title">
          <b>Ampertech — Estoque & Vendas</b>
          <small>Eletrônicos, capas e acessórios • GitHub Pages • Tema claro</small>
        </div>
      </div>

      <div class="tabs" role="tablist">
        <div class="tab active" id="tabVenda">Venda</div>
        <div class="tab" id="tabItens">Itens</div>
        <div class="tab" id="tabHist">Histórico</div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn info" id="btnBackup">Backup JSON</button>
        <button class="btn danger" id="btnReset">Limpar tudo</button>
      </div>
    </header>

    <section class="card" style="margin-bottom:12px">
      <div class="bd">
        <div class="kpis">
          <div class="kpi"><small>Itens</small><b id="kItens">0</b></div>
          <div class="kpi"><small>Estoque total</small><b id="kQtd">0</b></div>
          <div class="kpi"><small>Valor estoque (custo médio)</small><b id="kValor">R$ 0,00</b></div>
          <div class="kpi"><small>Alertas (baixo/zerado)</small><b id="kAlertas">0</b></div>
        </div>
      </div>
    </section>

    <!-- VENDA -->
    <section class="card" id="viewVenda">
      <div class="hd">
        <div>
          <h2>Venda Rápida</h2>
          <p>Selecione o item, informe quantidade e adicione no carrinho. Finalizar gera SAÍDA no estoque.</p>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn" id="btnLimparCarrinho">Limpar carrinho</button>
          <button class="btn primary" id="btnFinalizar">Finalizar venda</button>
        </div>
      </div>

      <div class="bd">
        <div class="grid">
          <div class="card" style="border-color:rgba(15,23,42,.10); box-shadow:none">
            <div class="bd">
              <div class="row">
                <div class="field span12">
                  <label>Busca rápida (código/descrição) — opcional</label>
                  <input id="vBusca" placeholder="Ex: CAPA IPHONE 13 / FONE / CABO..." />
                </div>

                <div class="field span7">
                  <label>Item</label>
                  <select id="vItem"></select>
                </div>

                <div class="field span2">
                  <label>Qtd</label>
                  <input id="vQtd" type="number" step="1" placeholder="1" />
                </div>

                <div class="field span3">
                  <label>Preço venda (R$) (opcional)</label>
                  <input id="vPreco" type="number" step="0.01" placeholder="0,00" />
                </div>

                <div class="field span12">
                  <label>Observação / cliente (opcional)</label>
                  <input id="vObs" placeholder="Ex: Cliente João / Pix / Cartão..." />
                </div>
              </div>

              <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; align-items:center">
                <button class="btn primary" id="btnAdd">Adicionar no carrinho</button>
                <span class="muted" id="vInfoEstoque">—</span>
              </div>
            </div>
          </div>

          <div class="card" style="border-color:rgba(15,23,42,.10); box-shadow:none">
            <div class="hd">
              <div>
                <h2>Carrinho</h2>
                <p class="muted">Itens adicionados nesta venda.</p>
              </div>
              <div class="pill ok" id="vTotal">Total: R$ 0,00</div>
            </div>
            <div class="bd" style="max-height:380px; overflow:auto">
              <table class="table" id="tblCarrinho">
                <thead>
                  <tr>
                    <th>Item</th>
                    <th style="text-align:right">Qtd</th>
                    <th style="text-align:right">Preço</th>
                    <th style="text-align:right">Total</th>
                    <th>Ação</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>

              <div class="muted" style="margin-top:10px; font-size:12px">
                Dica: para capas/acessórios, pode deixar “Preço venda” vazio e registrar só a saída.
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ITENS -->
    <section class="card hide" id="viewItens" style="margin-top:12px">
      <div class="hd">
        <div>
          <h2>Cadastro de Itens</h2>
          <p>Cadastre produtos. Entradas atualizam custo médio.</p>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <input id="iBusca" placeholder="Buscar item..." style="min-width:220px" />
          <button class="btn primary" id="btnSalvarItem">Salvar item</button>
          <button class="btn" id="btnNovoItem">Novo</button>
        </div>
      </div>

      <div class="bd">
        <div class="row">
          <div class="field span2">
            <label>Código *</label>
            <input id="iCodigo" placeholder="Ex: CAP-IPH13" />
          </div>
          <div class="field span6">
            <label>Descrição *</label>
            <input id="iDesc" placeholder="Ex: Capa iPhone 13 Silicone" />
          </div>
          <div class="field span2">
            <label>Categoria</label>
            <input id="iCat" placeholder="Capas / Acessórios / Celulares" />
          </div>
          <div class="field span2">
            <label>Unidade</label>
            <select id="iUn">
              <option value="UN">UN</option>
              <option value="CX">CX</option>
            </select>
          </div>

          <div class="field span2">
            <label>Custo (R$)</label>
            <input id="iCusto" type="number" step="0.01" placeholder="0,00" />
          </div>
          <div class="field span2">
            <label>Estoque</label>
            <input id="iEst" type="number" step="1" placeholder="0" />
          </div>
          <div class="field span2">
            <label>Mínimo</label>
            <input id="iMin" type="number" step="1" placeholder="0" />
          </div>
          <div class="field span6">
            <label>Obs</label>
            <input id="iObs" placeholder="Ex: fornecedor, cor, modelo..." />
          </div>

          <div class="field span12">
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
              <button class="btn info" id="btnEntradaRapida">Entrada rápida</button>
              <span class="muted">Entrada rápida gera ENTRADA (atualiza custo médio).</span>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div style="overflow:auto; border-radius:16px; max-height:520px">
          <table class="table" id="tblItens">
            <thead>
              <tr>
                <th>Código</th>
                <th style="min-width:260px">Descrição</th>
                <th>Categoria</th>
                <th>UN</th>
                <th style="text-align:right">Estoque</th>
                <th style="text-align:right">Mínimo</th>
                <th style="text-align:right">Custo médio</th>
                <th style="text-align:right">Valor estoque</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

      </div>
    </section>

    <!-- HISTÓRICO -->
    <section class="card hide" id="viewHist" style="margin-top:12px">
      <div class="hd">
        <div>
          <h2>Histórico</h2>
          <p>Movimentações: ENTRADA / SAÍDA / VENDA.</p>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <input id="hBusca" placeholder="Buscar no histórico..." style="min-width:220px" />
          <button class="btn" id="btnCsv">Exportar CSV</button>
        </div>
      </div>
      <div class="bd">
        <div style="overflow:auto; border-radius:16px; max-height:560px">
          <table class="table" id="tblHist">
            <thead>
              <tr>
                <th style="min-width:150px">Data/Hora</th>
                <th>Tipo</th>
                <th>Item</th>
                <th style="text-align:right">Qtd</th>
                <th style="text-align:right">Preço</th>
                <th style="text-align:right">Total</th>
                <th>Motivo</th>
                <th>Obs</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

  </div>

  <div class="toast" id="toast">OK</div>

<script>
  const LS_KEY = "ampertech_estoque_vendas_v1";
  const money = new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"});
  const num = (v)=>{ const n=Number(v); return Number.isFinite(n)?n:0; };
  const fmt = (n)=> num(n).toLocaleString("pt-BR",{minimumFractionDigits:0, maximumFractionDigits:2});
  const nowISO = ()=> new Date().toISOString();
  const toLocal = (iso)=> new Date(iso).toLocaleString("pt-BR");
  const uid = ()=> Math.random().toString(16).slice(2) + Date.now().toString(16);

  let DB = loadDB();
  let editItemId = null;
  let CART = []; // {itemId, qty, salePrice}

  function toast(msg){
    const t=document.getElementById("toast");
    t.textContent=msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2200);
  }
  function loadDB(){
    const raw=localStorage.getItem(LS_KEY);
    if(!raw) return {items:[], moves:[]};
    try{
      const db=JSON.parse(raw);
      db.items ??= [];
      db.moves ??= [];
      return db;
    }catch{ return {items:[], moves:[]}; }
  }
  function saveDB(){ localStorage.setItem(LS_KEY, JSON.stringify(DB)); }
  function esc(s){
    return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function applyMove(m){
    const it = DB.items.find(x=>x.id===m.itemId);
    if(!it) throw new Error("Item não encontrado.");
    const q = num(m.qty);
    if(q<=0) throw new Error("Qtd inválida.");

    if(m.type==="ENTRADA"){
      const p = num(m.price);
      if(p<=0) throw new Error("Preço inválido na entrada.");
      const est = num(it.stock);
      const cm = num(it.avgCost);
      const novoEst = est + q;
      const novoCM = ((est*cm) + (q*p)) / novoEst;
      it.stock = Math.round(novoEst);
      it.avgCost = +novoCM.toFixed(6);
      it.lastCost = +p.toFixed(6);
    }else{
      const est = num(it.stock);
      if(q>est) throw new Error("Estoque insuficiente.");
      it.stock = Math.round(est - q);
    }
  }

  function itemValue(it){ return num(it.stock) * num(it.avgCost); }
  function status(it){
    const est=num(it.stock), min=num(it.minStock);
    if(est<=0) return `<span class="pill zero">Zerado</span>`;
    if(min>0 && est<=min) return `<span class="pill low">Baixo</span>`;
    return `<span class="pill ok">OK</span>`;
  }

  // Tabs
  const tabVenda = document.getElementById("tabVenda");
  const tabItens = document.getElementById("tabItens");
  const tabHist  = document.getElementById("tabHist");
  const viewVenda = document.getElementById("viewVenda");
  const viewItens = document.getElementById("viewItens");
  const viewHist  = document.getElementById("viewHist");

  function setTab(which){
    [tabVenda,tabItens,tabHist].forEach(x=>x.classList.remove("active"));
    [viewVenda,viewItens,viewHist].forEach(x=>x.classList.add("hide"));
    if(which==="venda"){ tabVenda.classList.add("active"); viewVenda.classList.remove("hide"); }
    if(which==="itens"){ tabItens.classList.add("active"); viewItens.classList.remove("hide"); }
    if(which==="hist"){ tabHist.classList.add("active"); viewHist.classList.remove("hide"); }
  }
  tabVenda.onclick=()=>setTab("venda");
  tabItens.onclick=()=>setTab("itens");
  tabHist.onclick=()=>setTab("hist");

  // KPIs
  function refreshKPIs(){
    document.getElementById("kItens").textContent = DB.items.length;
    const qtdTotal = DB.items.reduce((a,it)=>a+num(it.stock),0);
    document.getElementById("kQtd").textContent = fmt(qtdTotal);
    const vTotal = DB.items.reduce((a,it)=>a+itemValue(it),0);
    document.getElementById("kValor").textContent = money.format(vTotal);
    const alerts = DB.items.filter(it=>{
      const est=num(it.stock), min=num(it.minStock);
      return est<=0 || (min>0 && est<=min);
    }).length;
    document.getElementById("kAlertas").textContent = alerts;
  }

  // Venda
  const vBusca = document.getElementById("vBusca");
  const vItem  = document.getElementById("vItem");
  const vQtd   = document.getElementById("vQtd");
  const vPreco = document.getElementById("vPreco");
  const vObs   = document.getElementById("vObs");
  const vInfoEstoque = document.getElementById("vInfoEstoque");

  function refreshVendaSelect(filterText=""){
    vItem.innerHTML="";
    const t = filterText.trim().toLowerCase();
    const list = [...DB.items]
      .filter(it=>{
        if(!t) return true;
        return (`${it.code} ${it.desc} ${it.category}`).toLowerCase().includes(t);
      })
      .sort((a,b)=>(a.code||"").localeCompare(b.code||""));

    for(const it of list){
      const opt=document.createElement("option");
      opt.value=it.id;
      opt.textContent = `${it.code} — ${it.desc} (Est: ${it.stock})`;
      vItem.appendChild(opt);
    }
    refreshVendaInfo();
  }

  function refreshVendaInfo(){
    const it = DB.items.find(x=>x.id===vItem.value);
    if(!it){ vInfoEstoque.textContent="Cadastre itens para vender."; return; }
    vInfoEstoque.textContent =
      `Estoque: ${it.stock} • Custo médio: ${money.format(num(it.avgCost))} • Categoria: ${it.category||"—"}`;
  }

  vBusca.addEventListener("input", ()=> refreshVendaSelect(vBusca.value));
  vItem.addEventListener("change", refreshVendaInfo);

  function cartTotal(){
    return CART.reduce((a,c)=> a + (num(c.qty)*num(c.salePrice)), 0);
  }

  function refreshCart(){
    const tb=document.querySelector("#tblCarrinho tbody");
    tb.innerHTML="";
    if(CART.length===0){
      const tr=document.createElement("tr");
      tr.innerHTML=`<td colspan="5" class="muted" style="padding:14px">Carrinho vazio.</td>`;
      tb.appendChild(tr);
    }else{
      CART.forEach((c,idx)=>{
        const it=DB.items.find(x=>x.id===c.itemId);
        const total = num(c.qty)*num(c.salePrice);
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td><b>${esc(it?.code||"")}</b> <span class="muted">— ${esc(it?.desc||"")}</span></td>
          <td style="text-align:right"><b>${fmt(c.qty)}</b></td>
          <td style="text-align:right">${money.format(num(c.salePrice))}</td>
          <td style="text-align:right"><b>${money.format(total)}</b></td>
          <td><button class="btn danger" data-rm="${idx}">Remover</button></td>
        `;
        tb.appendChild(tr);
      });
      tb.querySelectorAll("[data-rm]").forEach(b=>{
        b.onclick=()=>{
          CART.splice(Number(b.dataset.rm),1);
          refreshCart();
          toast("Item removido.");
        };
      });
    }
    document.getElementById("vTotal").textContent = `Total: ${money.format(cartTotal())}`;
  }

  document.getElementById("btnAdd").onclick=()=>{
    if(DB.items.length===0){ toast("Cadastre um item primeiro."); setTab("itens"); return; }
    const it = DB.items.find(x=>x.id===vItem.value);
    if(!it){ toast("Selecione um item."); return; }

    const q = Math.round(num(vQtd.value||1));
    if(!(q>0)){ toast("Quantidade inválida."); return; }
    if(q>num(it.stock)){ toast("Estoque insuficiente."); return; }

    const sp = num(vPreco.value || 0);

    const existing = CART.find(x=>x.itemId===it.id);
    if(existing){
      existing.qty += q;
      if(vPreco.value!=="" ) existing.salePrice = sp;
    }else{
      CART.push({itemId: it.id, qty: q, salePrice: sp});
    }

    vQtd.value="1";
    vPreco.value="";
    refreshVendaSelect(vBusca.value);
    refreshCart();
    toast("Adicionado no carrinho.");
  };

  document.getElementById("btnLimparCarrinho").onclick=()=>{
    if(!confirm("Limpar carrinho?")) return;
    CART=[];
    refreshCart();
  };

  document.getElementById("btnFinalizar").onclick=()=>{
    if(CART.length===0){ toast("Carrinho vazio."); return; }

    for(const c of CART){
      const it = DB.items.find(x=>x.id===c.itemId);
      if(!it) { toast("Item não encontrado."); return; }
      if(num(c.qty)>num(it.stock)){ toast(`Estoque insuficiente: ${it.code}`); return; }
    }

    const obsVenda = (vObs.value||"").trim();
    const vendaId = "VENDA-" + new Date().toISOString().slice(0,10).replaceAll("-","") + "-" + Math.random().toString(16).slice(2,6).toUpperCase();

    for(const c of CART){
      const it = DB.items.find(x=>x.id===c.itemId);

      const move = {
        id: uid(),
        at: nowISO(),
        type: "SAIDA",
        itemId: it.id,
        qty: Math.round(num(c.qty)),
        price: 0,
        reason: "VENDA",
        obs: `${vendaId}${obsVenda ? " • " + obsVenda : ""}${(c.salePrice>0) ? " • PreçoVenda: "+c.salePrice.toFixed(2) : ""}`
      };

      applyMove(move);
      DB.moves.push(move);
    }

    saveDB();
    CART=[];
    vObs.value="";
    refreshAll();
    refreshCart();
    toast("Venda finalizada!");
  };

  // Itens
  const iBusca=document.getElementById("iBusca");
  function clearItemForm(){
    editItemId=null;
    document.getElementById("iCodigo").value="";
    document.getElementById("iDesc").value="";
    document.getElementById("iCat").value="";
    document.getElementById("iUn").value="UN";
    document.getElementById("iCusto").value="";
    document.getElementById("iEst").value="0";
    document.getElementById("iMin").value="0";
    document.getElementById("iObs").value="";
    document.getElementById("iCodigo").focus();
  }
  document.getElementById("btnNovoItem").onclick=clearItemForm;

  function codeExists(code, ignoreId=null){
    const c=(code||"").trim().toLowerCase();
    return DB.items.some(it=>(it.code||"").trim().toLowerCase()===c && it.id!==ignoreId);
  }

  document.getElementById("btnSalvarItem").onclick=()=>{
    const code = document.getElementById("iCodigo").value.trim();
    const desc = document.getElementById("iDesc").value.trim();
    const cat  = document.getElementById("iCat").value.trim();
    const unit = document.getElementById("iUn").value;
    const cost = num(document.getElementById("iCusto").value);
    const est  = Math.round(num(document.getElementById("iEst").value));
    const min  = Math.round(num(document.getElementById("iMin").value));
    const obs  = document.getElementById("iObs").value.trim();

    if(!code || !desc){ toast("Preencha Código e Descrição."); return; }
    if(codeExists(code, editItemId)){ toast("Já existe esse código."); return; }

    if(editItemId){
      const it = DB.items.find(x=>x.id===editItemId);
      if(!it) return;

      it.code=code; it.desc=desc; it.category=cat; it.unit=unit; it.minStock=min; it.obs=obs;

      const old = num(it.stock);
      const diff = est - old;
      if(diff!==0){
        const m = {
          id: uid(),
          at: nowISO(),
          type: diff>0 ? "ENTRADA" : "SAIDA",
          itemId: it.id,
          qty: Math.abs(diff),
          price: diff>0 ? (cost>0?cost:num(it.avgCost)||1) : 0,
          reason: "Ajuste",
          obs: "Ajuste pelo cadastro"
        };
        it.stock = Math.round(old);
        if(m.type==="ENTRADA"){
          if(cost>0 && num(it.avgCost)<=0) it.avgCost = cost;
          applyMove(m); DB.moves.push(m);
        }else{
          applyMove(m); DB.moves.push(m);
        }
      }else{
        it.stock = Math.round(est);
      }

      if(num(it.avgCost)<=0 && cost>0) it.avgCost = +cost.toFixed(6);
      it.lastCost = +cost.toFixed(6);

      saveDB(); refreshAll(); toast("Item atualizado.");
      return;
    }

    const it = {
      id: uid(),
      code, desc, category:cat, unit,
      stock: 0,
      minStock: min,
      avgCost: (cost>0? +cost.toFixed(6) : 0),
      lastCost: (cost>0? +cost.toFixed(6) : 0),
      obs
    };
    DB.items.push(it);

    if(est>0 && cost>0){
      const m = { id: uid(), at: nowISO(), type:"ENTRADA", itemId: it.id, qty: est, price: cost, reason:"Estoque inicial", obs };
      applyMove(m); DB.moves.push(m);
    }else{
      it.stock = Math.round(est);
    }

    saveDB(); refreshAll(); toast("Item salvo."); clearItemForm();
  };

  document.getElementById("btnEntradaRapida").onclick=()=>{
    if(!editItemId){ toast("Carregue um item para editar."); return; }
    const it = DB.items.find(x=>x.id===editItemId);
    if(!it) return;
    const qtd = Number(prompt("Quantidade de ENTRADA:", "1"));
    const preco = Number(prompt("Preço de COMPRA unitário (R$):", (num(it.lastCost)||0).toFixed(2)));
    if(!(qtd>0) || !(preco>0)) { toast("Entrada cancelada."); return; }
    const m = { id: uid(), at: nowISO(), type:"ENTRADA", itemId: it.id, qty: Math.round(qtd), price: preco, reason:"Entrada", obs:"Entrada rápida" };
    try{
      applyMove(m); DB.moves.push(m);
      saveDB(); refreshAll(); toast("Entrada registrada.");
    }catch(e){ toast(e.message||"Erro na entrada."); }
  };

  function refreshItensTable(){
    const tb=document.querySelector("#tblItens tbody");
    tb.innerHTML="";
    const q=(iBusca.value||"").trim().toLowerCase();
    const items=[...DB.items]
      .filter(it=>{
        if(!q) return true;
        return (`${it.code} ${it.desc} ${it.category}`).toLowerCase().includes(q);
      })
      .sort((a,b)=>(a.code||"").localeCompare(b.code||""));

    if(items.length===0){
      const tr=document.createElement("tr");
      tr.innerHTML=`<td colspan="10" class="muted" style="padding:14px">Nenhum item.</td>`;
      tb.appendChild(tr);
      return;
    }

    for(const it of items){
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td><b>${esc(it.code)}</b></td>
        <td>${esc(it.desc)}</td>
        <td class="muted">${esc(it.category||"—")}</td>
        <td class="muted">${esc(it.unit||"UN")}</td>
        <td style="text-align:right"><b>${fmt(it.stock)}</b></td>
        <td style="text-align:right" class="muted">${fmt(it.minStock)}</td>
        <td style="text-align:right">${money.format(num(it.avgCost))}</td>
        <td style="text-align:right"><b>${money.format(itemValue(it))}</b></td>
        <td>${status(it)}</td>
        <td>
          <button class="btn" data-edit="${it.id}">Editar</button>
          <button class="btn danger" data-del="${it.id}">Excluir</button>
        </td>
      `;
      tb.appendChild(tr);
    }

    tb.querySelectorAll("[data-edit]").forEach(b=>{
      b.onclick=()=>{
        const it = DB.items.find(x=>x.id===b.dataset.edit);
        if(!it) return;
        editItemId=it.id;
        document.getElementById("iCodigo").value=it.code||"";
        document.getElementById("iDesc").value=it.desc||"";
        document.getElementById("iCat").value=it.category||"";
        document.getElementById("iUn").value=it.unit||"UN";
        document.getElementById("iCusto").value=(num(it.lastCost||it.avgCost)||0).toFixed(2);
        document.getElementById("iEst").value=Math.round(num(it.stock));
        document.getElementById("iMin").value=Math.round(num(it.minStock));
        document.getElementById("iObs").value=it.obs||"";
        toast("Item carregado.");
        setTab("itens");
      };
    });

    tb.querySelectorAll("[data-del]").forEach(b=>{
      b.onclick=()=>{
        const it = DB.items.find(x=>x.id===b.dataset.del);
        if(!it) return;
        if(!confirm(`Excluir ${it.code}? Isso remove o histórico desse item.`)) return;
        DB.items = DB.items.filter(x=>x.id!==it.id);
        DB.moves = DB.moves.filter(m=>m.itemId!==it.id);
        if(editItemId===it.id) clearItemForm();
        saveDB(); refreshAll(); toast("Excluído.");
      };
    });
  }
  iBusca.addEventListener("input", refreshItensTable);

  // Histórico
  const hBusca=document.getElementById("hBusca");
  function refreshHist(){
    const tb=document.querySelector("#tblHist tbody");
    tb.innerHTML="";
    const q=(hBusca.value||"").trim().toLowerCase();
    const moves=[...DB.moves].sort((a,b)=>(b.at||"").localeCompare(a.at||""))
      .filter(m=>{
        if(!q) return true;
        const it=DB.items.find(x=>x.id===m.itemId);
        const text = `${m.type} ${it?.code||""} ${it?.desc||""} ${m.reason||""} ${m.obs||""}`.toLowerCase();
        return text.includes(q);
      });

    if(moves.length===0){
      const tr=document.createElement("tr");
      tr.innerHTML=`<td colspan="8" class="muted" style="padding:14px">Sem movimentações.</td>`;
      tb.appendChild(tr);
      return;
    }

    for(const m of moves){
      const it=DB.items.find(x=>x.id===m.itemId);
      const total = (m.type==="ENTRADA")
        ? (num(m.qty)*num(m.price))
        : (num(m.qty)*num(it?.avgCost));
      const tipoPill = (m.type==="ENTRADA")
        ? `<span class="pill ok">ENTRADA</span>`
        : `<span class="pill low">SAÍDA</span>`;

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td class="muted">${toLocal(m.at)}</td>
        <td>${tipoPill}</td>
        <td><b>${esc(it?.code||"—")}</b> <span class="muted">— ${esc(it?.desc||"—")}</span></td>
        <td style="text-align:right"><b>${fmt(m.qty)}</b></td>
        <td style="text-align:right">${m.type==="ENTRADA" ? money.format(num(m.price)) : "<span class='muted'>—</span>"}</td>
        <td style="text-align:right"><b>${money.format(total)}</b></td>
        <td>${esc(m.reason||"—")}</td>
        <td class="muted">${esc(m.obs||"")}</td>
      `;
      tb.appendChild(tr);
    }
  }
  hBusca.addEventListener("input", refreshHist);

  // Backup / CSV / Reset
  document.getElementById("btnBackup").onclick=()=>{
    const payload = {version:1, exportedAt: nowISO(), items: DB.items, moves: DB.moves};
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download="ampertech_backup.json";
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),800);
    toast("Backup baixado.");
  };

  document.getElementById("btnCsv").onclick=()=>{
    const header=["data_hora","tipo","codigo","descricao","qtd","preco","total","motivo","obs"];
    const rows = [...DB.moves].sort((a,b)=>(b.at||"").localeCompare(a.at||"")).map(m=>{
      const it=DB.items.find(x=>x.id===m.itemId);
      const total=(m.type==="ENTRADA") ? (num(m.qty)*num(m.price)) : (num(m.qty)*num(it?.avgCost));
      return [toLocal(m.at), m.type, it?.code||"", it?.desc||"", num(m.qty), (m.type==="ENTRADA")? num(m.price) : "", total, m.reason||"", m.obs||""];
    });
    const escCSV = (v)=>{
      const s=String(v??"");
      return /[",\n;]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    };
    const csv = [header, ...rows].map(r=>r.map(escCSV).join(";")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download="ampertech_historico.csv";
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),800);
    toast("CSV baixado.");
  };

  document.getElementById("btnReset").onclick=()=>{
    if(!confirm("Apagar tudo (itens + histórico)?")) return;
    localStorage.removeItem(LS_KEY);
    DB={items:[], moves:[]};
    CART=[];
    clearItemForm();
    refreshAll();
    refreshCart();
    toast("Dados apagados.");
  };

  // Refresh geral
  function refreshAll(){
    refreshKPIs();
    refreshItensTable();
    refreshHist();
    refreshVendaSelect(vBusca.value);
    refreshVendaInfo();
  }

  // init
  clearItemForm();
  refreshAll();
  refreshCart();
  setTab("venda");
</script>
</body>
</html>
