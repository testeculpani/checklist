<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ampertech — Estoque & Vendas</title>
  <meta name="theme-color" content="#0b5ed7" />
  <style>
    :root{
      --bg:#eef3ff;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#5b6b85;
      --line:rgba(11,18,32,.12);

      --ok:#16a34a;
      --info:#0b5ed7;   /* mais forte */
      --warn:#d97706;
      --danger:#e11d48;

      --shadow: 0 12px 30px rgba(2,6,23,.14);
      --r:18px;
      --r2:14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1100px 560px at 20% 0%, rgba(11,94,215,.22), transparent 55%),
        radial-gradient(900px 520px at 100% 0%, rgba(22,163,74,.16), transparent 55%),
        linear-gradient(180deg, rgba(11,94,215,.08), transparent 40%),
        var(--bg);
    }
    .wrap{max-width:1150px; margin:0 auto; padding:16px 12px 90px}

    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:8px 4px 14px; flex-wrap:wrap;
    }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{
      width:46px; height:46px; border-radius:16px;
      background: linear-gradient(135deg, rgba(11,94,215,.35), rgba(22,163,74,.22));
      border:1px solid rgba(255,255,255,.55);
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      font-weight:950; letter-spacing:.5px;
      color:#081225;
    }
    .title b{font-size:15px}
    .title small{display:block; margin-top:2px; color:var(--muted); font-size:12px}

    .btn{
      border:1px solid rgba(11,18,32,.12);
      background:rgba(255,255,255,.92);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:950;
      font-size:13px;
      display:inline-flex; align-items:center; gap:8px;
      transition:.12s ease;
      box-shadow: 0 8px 18px rgba(2,6,23,.10);
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); background:#fff}
    .btn:active{transform:translateY(0)}
    .btn.primary{border-color:rgba(22,163,74,.30); background:rgba(22,163,74,.12)}
    .btn.info{border-color:rgba(11,94,215,.35); background:rgba(11,94,215,.12)}
    .btn.warn{border-color:rgba(217,119,6,.28); background:rgba(217,119,6,.12)}
    .btn.danger{border-color:rgba(225,29,72,.25); background:rgba(225,29,72,.10)}

    .card{
      background: var(--card);
      border:1px solid rgba(11,18,32,.10);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:14px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
      background:
        radial-gradient(900px 280px at 0% 0%, rgba(11,94,215,.18), transparent 55%),
        linear-gradient(180deg, rgba(11,94,215,.10), transparent);
    }
    .hd h2{margin:0; font-size:14px}
    .hd p{margin:4px 0 0; font-size:12px; color:var(--muted); line-height:1.35}
    .bd{padding:14px}

    .tabs{display:flex; gap:10px; flex-wrap:wrap}
    .tab{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(11,18,32,.12);
      background:rgba(255,255,255,.92);
      cursor:pointer;
      font-weight:950;
      font-size:13px;
      white-space:nowrap;
    }
    .tab.active{
      border-color:rgba(11,94,215,.55);
      background:rgba(11,94,215,.14);
    }

    .grid{display:grid; grid-template-columns:1.05fr .95fr; gap:12px}
    @media(max-width:980px){ .grid{grid-template-columns:1fr} }

    label{font-size:11px; color:var(--muted); font-weight:950; letter-spacing:.2px}
    input, select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(11,18,32,.12);
      background:#fff;
      color:var(--text);
      padding:10px 11px;
      font-size:13px;
      outline:none;
    }
    input:focus, select:focus{
      border-color: rgba(11,94,215,.55);
      box-shadow: 0 0 0 3px rgba(11,94,215,.18);
    }

    .row{display:grid; grid-template-columns:repeat(12,1fr); gap:10px; align-items:end}
    .field{grid-column:span 3; display:flex; flex-direction:column; gap:6px}
    .span2{grid-column:span 2}
    .span3{grid-column:span 3}
    .span4{grid-column:span 4}
    .span5{grid-column:span 5}
    .span6{grid-column:span 6}
    .span7{grid-column:span 7}
    .span12{grid-column:span 12}

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border:1px solid rgba(11,18,32,.10);
      border-radius:16px;
      overflow:hidden;
      background: #fff;
    }
    .table th,.table td{
      padding:10px;
      font-size:12px;
      border-bottom:1px solid rgba(11,18,32,.08);
      text-align:left;
      white-space:nowrap;
      vertical-align:middle;
    }
    .table th{
      font-size:11px;
      color:var(--muted);
      font-weight:950;
      background: rgba(11,94,215,.10);
      position:sticky; top:0;
      z-index:1;
    }
    .table tr:hover td{background: rgba(11,94,215,.06)}
    .muted{color:var(--muted)}

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(11,18,32,.12);
      background: rgba(11,18,32,.04);
      font-weight:950;
      font-size:11px;
      white-space:nowrap;
    }
    .pill.ok{border-color:rgba(22,163,74,.30); background:rgba(22,163,74,.12)}
    .pill.low{border-color:rgba(217,119,6,.28); background:rgba(217,119,6,.12)}
    .pill.zero{border-color:rgba(225,29,72,.22); background:rgba(225,29,72,.10)}
    .pill.info{border-color:rgba(11,94,215,.35); background:rgba(11,94,215,.14)}
    .pill.warn{border-color:rgba(217,119,6,.28); background:rgba(217,119,6,.12)}

    .hr{height:1px; background:var(--line); margin:12px 0}

    .toast{
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background: rgba(255,255,255,.96);
      border:1px solid rgba(11,18,32,.14);
      padding:10px 12px;
      border-radius:999px;
      box-shadow: var(--shadow);
      display:none;
      font-size:12px;
      font-weight:950;
      z-index:60;
    }
    .toast.show{display:block}
    .hide{display:none !important}

    .modal{
      position:fixed; inset:0;
      background: rgba(2,6,23,.42);
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      z-index:70;
      backdrop-filter: blur(6px);
    }
    .modal.show{display:flex}
    .modal .box{
      width:min(720px, 100%);
      background:#fff;
      border:1px solid rgba(11,18,32,.14);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .mh{
      padding:14px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(180deg, rgba(11,94,215,.14), transparent);
    }
    .modal .mh b{font-size:14px}
    .x{
      width:40px; height:40px;
      border-radius:14px;
      border:1px solid rgba(11,18,32,.12);
      background: rgba(255,255,255,.9);
      cursor:pointer;
      display:grid; place-items:center;
      font-weight:950;
    }
    .modal .mb{padding:14px}
    .modal .mf{
      padding:12px 14px;
      border-top:1px solid var(--line);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      background: rgba(11,94,215,.08);
    }

    .bigInput{
      font-size:16px;
      padding:12px 12px;
      border-radius:16px;
      font-weight:900;
    }
    .hint{font-size:12px; color:var(--muted); margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">AT</div>
        <div class="title">
          <b>Ampertech — Estoque & Vendas</b>
          <small>Cadastro com preço sugerido • Venda com sugestão automática</small>
        </div>
      </div>

      <div class="tabs" role="tablist">
        <div class="tab active" id="tabVenda">Venda</div>
        <div class="tab" id="tabItens">Itens</div>
        <div class="tab" id="tabHist">Histórico</div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn danger" id="btnReset">Limpar tudo</button>
      </div>
    </header>

    <!-- VENDA -->
    <section class="card" id="viewVenda">
      <div class="hd">
        <div>
          <h2>Venda Rápida</h2>
          <p>Digite parte do nome/código e escolha. Ao selecionar, o <b>preço sugerido</b> entra automático.</p>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn" id="btnLimparCarrinho">Limpar carrinho</button>
          <button class="btn primary" id="btnFinalizar">Finalizar venda</button>
        </div>
      </div>

      <div class="bd">
        <div class="grid">
          <!-- Adicionar -->
          <div class="card" style="border-color:rgba(11,18,32,.10); box-shadow:none">
            <div class="bd">
              <div class="row">
                <div class="field span12">
                  <label>Pesquisar produto (nome/código)</label>
                  <input id="vBuscaProduto" class="bigInput"
                         list="dlProdutos"
                         placeholder="Ex: capa iphone / carregador / CAP-IPH13..." />
                  <datalist id="dlProdutos"></datalist>
                  <div class="hint">Ao escolher, ele seleciona o item e sugere o preço.</div>
                </div>

                <div class="field span7">
                  <label>Item selecionado</label>
                  <select id="vItem"></select>
                </div>

                <div class="field span2">
                  <label>Qtd</label>
                  <input id="vQtd" type="number" step="1" value="1" />
                </div>

                <div class="field span3">
                  <label>Preço de venda (R$) *</label>
                  <input id="vPreco" type="number" step="0.01" placeholder="Ex: 49,90" />
                </div>

                <div class="field span12">
                  <label>Observação / cliente (opcional)</label>
                  <input id="vObs" placeholder="Ex: Cliente João • Pix • Cartão..." />
                </div>
              </div>

              <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; align-items:center">
                <button class="btn primary" id="btnAdd">Adicionar no carrinho</button>
                <span class="pill info" id="vInfoEstoque">—</span>
              </div>
            </div>
          </div>

          <!-- Carrinho -->
          <div class="card" style="border-color:rgba(11,18,32,.10); box-shadow:none">
            <div class="hd">
              <div>
                <h2>Carrinho</h2>
                <p class="muted">Venda vs Custo.</p>
              </div>
              <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
                <div class="pill ok" id="vTotalVenda">Venda: R$ 0,00</div>
                <div class="pill warn" id="vTotalCusto">Custo: R$ 0,00</div>
              </div>
            </div>
            <div class="bd" style="max-height:420px; overflow:auto">
              <table class="table" id="tblCarrinho">
                <thead>
                  <tr>
                    <th>Item</th>
                    <th style="text-align:right">Qtd</th>
                    <th style="text-align:right">Venda</th>
                    <th style="text-align:right">Total</th>
                    <th style="text-align:right">Custo</th>
                    <th>Ação</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- ITENS -->
    <section class="card hide" id="viewItens" style="margin-top:12px">
      <div class="hd">
        <div>
          <h2>Itens (Cadastro + Entrada/Saída)</h2>
          <p>Cadastre com <b>preço sugerido</b> e use Entrada/Saída por item.</p>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <input id="iBusca" placeholder="Buscar item..." style="min-width:220px" />
          <button class="btn primary" id="btnSalvarItem">Salvar item</button>
          <button class="btn" id="btnNovoItem">Novo</button>
        </div>
      </div>

      <div class="bd">
        <div class="row">
          <div class="field span2">
            <label>Código *</label>
            <input id="iCodigo" placeholder="Ex: CAP-IPH13" />
          </div>
          <div class="field span6">
            <label>Descrição *</label>
            <input id="iDesc" placeholder="Ex: Capa iPhone 13 Silicone" />
          </div>
          <div class="field span2">
            <label>Categoria</label>
            <input id="iCat" placeholder="Capas / Acessórios / Celulares" />
          </div>
          <div class="field span2">
            <label>Unidade</label>
            <select id="iUn">
              <option value="UN">UN</option>
              <option value="CX">CX</option>
            </select>
          </div>

          <div class="field span3">
            <label>Custo (R$) (compra)</label>
            <input id="iCusto" type="number" step="0.01" placeholder="0,00" />
          </div>
          <div class="field span3">
            <label>Preço sugerido venda (R$)</label>
            <input id="iVendaSug" type="number" step="0.01" placeholder="Ex: 49,90" />
          </div>
          <div class="field span2">
            <label>Estoque inicial</label>
            <input id="iEst" type="number" step="1" placeholder="0" />
          </div>
          <div class="field span2">
            <label>Mínimo</label>
            <input id="iMin" type="number" step="1" placeholder="0" />
          </div>
          <div class="field span2">
            <label>Obs</label>
            <input id="iObs" placeholder="Ex: modelo, cor..." />
          </div>
        </div>

        <div class="hr"></div>

        <div style="overflow:auto; border-radius:16px; max-height:560px">
          <table class="table" id="tblItens">
            <thead>
              <tr>
                <th>Código</th>
                <th style="min-width:260px">Descrição</th>
                <th>Categoria</th>
                <th>UN</th>
                <th style="text-align:right">Estoque</th>
                <th style="text-align:right">Mínimo</th>
                <th style="text-align:right">Custo médio</th>
                <th style="text-align:right">Sug. venda</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

      </div>
    </section>

    <!-- HISTÓRICO -->
    <section class="card hide" id="viewHist" style="margin-top:12px">
      <div class="hd">
        <div>
          <h2>Histórico (Venda x Custo)</h2>
          <p>Quando é VENDA: mostra venda, custo e lucro.</p>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <input id="hBusca" placeholder="Buscar no histórico..." style="min-width:220px" />
          <button class="btn" id="btnCsv">Exportar CSV</button>
        </div>
      </div>
      <div class="bd">
        <div style="overflow:auto; border-radius:16px; max-height:620px">
          <table class="table" id="tblHist">
            <thead>
              <tr>
                <th style="min-width:150px">Data/Hora</th>
                <th>Tipo</th>
                <th>Item</th>
                <th style="text-align:right">Qtd</th>
                <th style="text-align:right">Compra (R$)</th>
                <th style="text-align:right">Venda (R$)</th>
                <th style="text-align:right">Custo (R$)</th>
                <th style="text-align:right">Lucro (R$)</th>
                <th>Motivo</th>
                <th>Obs</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

  </div>

  <!-- Modal Entrada/Saída -->
  <div class="modal" id="modalMov">
    <div class="box">
      <div class="mh">
        <div>
          <b id="mTitle">Movimentação</b>
          <div class="muted" style="font-size:12px; margin-top:3px" id="mSub">—</div>
        </div>
        <div class="x" id="mClose">✕</div>
      </div>
      <div class="mb">
        <div class="row">
          <div class="field span6">
            <label>Tipo</label>
            <select id="mTipo">
              <option value="ENTRADA">ENTRADA</option>
              <option value="SAIDA">SAÍDA</option>
            </select>
          </div>
          <div class="field span3">
            <label>Qtd</label>
            <input id="mQtd" type="number" step="1" value="1" />
          </div>
          <div class="field span3" id="mPrecoBox">
            <label>Preço compra (R$) (na ENTRADA)</label>
            <input id="mPreco" type="number" step="0.01" placeholder="0,00" />
          </div>
          <div class="field span12">
            <label>Motivo/Obs (opcional)</label>
            <input id="mObs" placeholder="Ex: NF 123 • reposição • ajuste..." />
          </div>
        </div>

        <div class="hr"></div>
        <div class="pill info" id="mPreview">—</div>
      </div>
      <div class="mf">
        <button class="btn" id="mCancel">Cancelar</button>
        <button class="btn primary" id="mSave">Salvar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">OK</div>

<script>
  const LS_KEY = "ampertech_estoque_vendas_v4";
  const money = new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"});
  const num = (v)=>{ const n=Number(v); return Number.isFinite(n)?n:0; };
  const nowISO = ()=> new Date().toISOString();
  const toLocal = (iso)=> new Date(iso).toLocaleString("pt-BR");
  const uid = ()=> Math.random().toString(16).slice(2) + Date.now().toString(16);

  let DB = loadDB();
  let editItemId = null;
  let CART = [];
  let MODAL_ITEM_ID = null;

  function toast(msg){
    const t=document.getElementById("toast");
    t.textContent=msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2200);
  }
  function loadDB(){
    const raw=localStorage.getItem(LS_KEY);
    if(!raw) return {items:[], moves:[]};
    try{
      const db=JSON.parse(raw);
      db.items ??= [];
      db.moves ??= [];
      for(const it of db.items){
        it.stock ??= 0;
        it.avgCost ??= 0;
        it.minStock ??= 0;
        it.suggestSell ??= 0; // novo campo
      }
      return db;
    }catch{ return {items:[], moves:[]}; }
  }
  function saveDB(){ localStorage.setItem(LS_KEY, JSON.stringify(DB)); }
  function esc(s){
    return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function status(it){
    const est=num(it.stock), min=num(it.minStock);
    if(est<=0) return `<span class="pill zero">Zerado</span>`;
    if(min>0 && est<=min) return `<span class="pill low">Baixo</span>`;
    return `<span class="pill ok">OK</span>`;
  }

  function applyMove(m){
    const it = DB.items.find(x=>x.id===m.itemId);
    if(!it) throw new Error("Item não encontrado.");
    const q = Math.round(num(m.qty));
    if(q<=0) throw new Error("Qtd inválida.");

    if(m.type==="ENTRADA"){
      const p = num(m.priceBuy);
      if(p<=0) throw new Error("Preço de compra inválido na ENTRADA.");
      const est = num(it.stock);
      const cm = num(it.avgCost);
      const novoEst = est + q;
      const novoCM = ((est*cm) + (q*p)) / novoEst;
      it.stock = Math.round(novoEst);
      it.avgCost = +novoCM.toFixed(6);
      it.lastCost = +p.toFixed(6);
    } else {
      const est = num(it.stock);
      if(q>est) throw new Error("Estoque insuficiente.");
      it.stock = Math.round(est - q);
    }
  }

  // Tabs
  const tabVenda = document.getElementById("tabVenda");
  const tabItens = document.getElementById("tabItens");
  const tabHist  = document.getElementById("tabHist");
  const viewVenda = document.getElementById("viewVenda");
  const viewItens = document.getElementById("viewItens");
  const viewHist  = document.getElementById("viewHist");

  function setTab(which){
    [tabVenda,tabItens,tabHist].forEach(x=>x.classList.remove("active"));
    [viewVenda,viewItens,viewHist].forEach(x=>x.classList.add("hide"));
    if(which==="venda"){ tabVenda.classList.add("active"); viewVenda.classList.remove("hide"); }
    if(which==="itens"){ tabItens.classList.add("active"); viewItens.classList.remove("hide"); }
    if(which==="hist"){ tabHist.classList.add("active"); viewHist.classList.remove("hide"); }
  }
  tabVenda.onclick=()=>setTab("venda");
  tabItens.onclick=()=>setTab("itens");
  tabHist.onclick=()=>setTab("hist");

  // VENDA
  const vBuscaProduto = document.getElementById("vBuscaProduto");
  const dlProdutos = document.getElementById("dlProdutos");
  const vItem  = document.getElementById("vItem");
  const vQtd   = document.getElementById("vQtd");
  const vPreco = document.getElementById("vPreco");
  const vObs   = document.getElementById("vObs");
  const vInfoEstoque = document.getElementById("vInfoEstoque");
  let DL_MAP = new Map();

  function refreshVendaSelect(){
    vItem.innerHTML="";
    const list = [...DB.items].sort((a,b)=>(a.code||"").localeCompare(b.code||""));
    for(const it of list){
      const opt=document.createElement("option");
      opt.value=it.id;
      opt.textContent = `${it.code} — ${it.desc} (Est: ${it.stock})`;
      vItem.appendChild(opt);
    }
    refreshVendaInfoAndSuggest();
  }

  function rebuildDatalist(){
    dlProdutos.innerHTML="";
    DL_MAP = new Map();
    const list = [...DB.items].sort((a,b)=>(a.desc||"").localeCompare(b.desc||""));
    for(const it of list){
      const text = `${it.code} — ${it.desc} (Est: ${it.stock})`;
      const o = document.createElement("option");
      o.value = text;
      dlProdutos.appendChild(o);
      DL_MAP.set(text, it.id);
    }
  }

  function refreshVendaInfoAndSuggest(){
    const it = DB.items.find(x=>x.id===vItem.value);
    if(!it){
      vInfoEstoque.textContent="Cadastre itens para vender.";
      return;
    }
    vInfoEstoque.textContent =
      `Estoque: ${it.stock} • CM: ${money.format(num(it.avgCost))} • Sug. venda: ${money.format(num(it.suggestSell))}`;

    // Preenche preço sugerido se estiver vazio ou 0
    const curr = num(vPreco.value);
    if(!(curr>0) && num(it.suggestSell)>0){
      vPreco.value = num(it.suggestSell).toFixed(2);
    }
  }

  vItem.addEventListener("change", refreshVendaInfoAndSuggest);

  function trySelectFromSearch(){
    const raw = (vBuscaProduto.value||"").trim();
    if(!raw) return;

    if(DL_MAP.has(raw)){
      vItem.value = DL_MAP.get(raw);
      refreshVendaInfoAndSuggest();
      return;
    }

    const code = raw.toLowerCase();
    const it = DB.items.find(x => (x.code||"").trim().toLowerCase() === code);
    if(it){
      vItem.value = it.id;
      refreshVendaInfoAndSuggest();
      return;
    }
  }

  vBuscaProduto.addEventListener("input", trySelectFromSearch);
  vBuscaProduto.addEventListener("change", trySelectFromSearch);
  vBuscaProduto.addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){
      trySelectFromSearch();
      const it = DB.items.find(x=>x.id===vItem.value);
      if(it){
        e.preventDefault();
        vPreco.focus();
      }
    }
  });

  function cartTotals(){
    const totalVenda = CART.reduce((a,c)=> a + (num(c.qty)*num(c.salePrice)), 0);
    const totalCusto = CART.reduce((a,c)=>{
      const it = DB.items.find(x=>x.id===c.itemId);
      return a + (num(c.qty)*num(it?.avgCost));
    }, 0);
    return {totalVenda, totalCusto};
  }

  function refreshCart(){
    const tb=document.querySelector("#tblCarrinho tbody");
    tb.innerHTML="";

    if(CART.length===0){
      const tr=document.createElement("tr");
      tr.innerHTML=`<td colspan="6" class="muted" style="padding:14px">Carrinho vazio.</td>`;
      tb.appendChild(tr);
    } else {
      CART.forEach((c,idx)=>{
        const it=DB.items.find(x=>x.id===c.itemId);
        const total = num(c.qty)*num(c.salePrice);
        const custo = num(c.qty)*num(it?.avgCost);
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td><b>${esc(it?.code||"")}</b> <span class="muted">— ${esc(it?.desc||"")}</span></td>
          <td style="text-align:right"><b>${Math.round(num(c.qty)).toLocaleString("pt-BR")}</b></td>
          <td style="text-align:right">${money.format(num(c.salePrice))}</td>
          <td style="text-align:right"><b>${money.format(total)}</b></td>
          <td style="text-align:right">${money.format(custo)}</td>
          <td><button class="btn danger" data-rm="${idx}">Remover</button></td>
        `;
        tb.appendChild(tr);
      });
      tb.querySelectorAll("[data-rm]").forEach(b=>{
        b.onclick=()=>{
          CART.splice(Number(b.dataset.rm),1);
          refreshCart();
          toast("Item removido.");
        };
      });
    }

    const {totalVenda, totalCusto} = cartTotals();
    document.getElementById("vTotalVenda").textContent = `Venda: ${money.format(totalVenda)}`;
    document.getElementById("vTotalCusto").textContent = `Custo: ${money.format(totalCusto)}`;
  }

  function addToCart(itemId, qty, salePrice){
    const it = DB.items.find(x=>x.id===itemId);
    if(!it) { toast("Item não encontrado."); return; }

    const q = Math.round(num(qty));
    if(!(q>0)){ toast("Quantidade inválida."); return; }
    if(q>num(it.stock)){ toast("Estoque insuficiente."); return; }

    const sp = num(salePrice);
    if(!(sp>0)){ toast("Informe o preço de venda (R$)."); return; }

    const existing = CART.find(x=>x.itemId===it.id && num(x.salePrice)===sp);
    if(existing) existing.qty += q;
    else CART.push({itemId: it.id, qty: q, salePrice: sp});

    refreshCart();
    toast("Adicionado no carrinho.");
  }

  document.getElementById("btnAdd").onclick=()=>{
    if(DB.items.length===0){ toast("Cadastre um item primeiro."); setTab("itens"); return; }
    const it = DB.items.find(x=>x.id===vItem.value);
    if(!it){ toast("Selecione um item."); return; }
    addToCart(it.id, vQtd.value||1, vPreco.value);

    vQtd.value = 1;
    vPreco.value = "";
    vBuscaProduto.value = "";
    vBuscaProduto.focus();

    refreshVendaSelect();
    rebuildDatalist();
  };

  document.getElementById("btnLimparCarrinho").onclick=()=>{
    if(!confirm("Limpar carrinho?")) return;
    CART=[];
    refreshCart();
  };

  document.getElementById("btnFinalizar").onclick=()=>{
    if(CART.length===0){ toast("Carrinho vazio."); return; }

    for(const c of CART){
      const it = DB.items.find(x=>x.id===c.itemId);
      if(!it) { toast("Item não encontrado."); return; }
      if(num(c.qty)>num(it.stock)){ toast(`Estoque insuficiente: ${it.code}`); return; }
      if(!(num(c.salePrice)>0)){ toast(`Preço de venda inválido: ${it.code}`); return; }
    }

    const obsVenda = (vObs.value||"").trim();
    const vendaId = "VENDA-" + new Date().toISOString().slice(0,10).replaceAll("-","") + "-" + Math.random().toString(16).slice(2,6).toUpperCase();

    for(const c of CART){
      const it = DB.items.find(x=>x.id===c.itemId);
      const move = {
        id: uid(),
        at: nowISO(),
        type: "VENDA",
        itemId: it.id,
        qty: Math.round(num(c.qty)),
        priceBuy: 0,
        priceSell: num(c.salePrice),
        reason: "VENDA",
        obs: `${vendaId}${obsVenda ? " • " + obsVenda : ""}`
      };
      applyMove(move);
      DB.moves.push(move);
    }

    saveDB();
    CART=[];
    vObs.value="";
    vPreco.value="";
    vBuscaProduto.value="";
    refreshAll();
    refreshCart();
    toast("Venda finalizada!");
    vBuscaProduto.focus();
  };

  // ITENS
  const iBusca=document.getElementById("iBusca");
  function clearItemForm(){
    editItemId=null;
    document.getElementById("iCodigo").value="";
    document.getElementById("iDesc").value="";
    document.getElementById("iCat").value="";
    document.getElementById("iUn").value="UN";
    document.getElementById("iCusto").value="";
    document.getElementById("iVendaSug").value="";
    document.getElementById("iEst").value="0";
    document.getElementById("iMin").value="0";
    document.getElementById("iObs").value="";
    document.getElementById("iCodigo").focus();
  }
  document.getElementById("btnNovoItem").onclick=clearItemForm;

  function codeExists(code, ignoreId=null){
    const c=(code||"").trim().toLowerCase();
    return DB.items.some(it=>(it.code||"").trim().toLowerCase()===c && it.id!==ignoreId);
  }

  document.getElementById("btnSalvarItem").onclick=()=>{
    const code = document.getElementById("iCodigo").value.trim();
    const desc = document.getElementById("iDesc").value.trim();
    const cat  = document.getElementById("iCat").value.trim();
    const unit = document.getElementById("iUn").value;
    const cost = num(document.getElementById("iCusto").value);
    const vendaSug = num(document.getElementById("iVendaSug").value);
    const est  = Math.round(num(document.getElementById("iEst").value));
    const min  = Math.round(num(document.getElementById("iMin").value));
    const obs  = document.getElementById("iObs").value.trim();

    if(!code || !desc){ toast("Preencha Código e Descrição."); return; }
    if(codeExists(code, editItemId)){ toast("Já existe esse código."); return; }

    if(editItemId){
      const it = DB.items.find(x=>x.id===editItemId);
      if(!it) return;

      it.code=code; it.desc=desc; it.category=cat; it.unit=unit; it.minStock=min; it.obs=obs;
      it.suggestSell = vendaSug;
      if(num(it.avgCost)<=0 && cost>0) it.avgCost = +cost.toFixed(6);
      if(cost>0) it.lastCost = +cost.toFixed(6);

      const old = Math.round(num(it.stock));
      const diff = est - old;
      if(diff!==0){
        const m = {
          id: uid(),
          at: nowISO(),
          type: diff>0 ? "ENTRADA" : "SAIDA",
          itemId: it.id,
          qty: Math.abs(diff),
          priceBuy: diff>0 ? (cost>0?cost:num(it.avgCost)||1) : 0,
          priceSell: 0,
          reason: "AJUSTE",
          obs: "Ajuste pelo cadastro"
        };
        it.stock = old;
        try{ applyMove(m); DB.moves.push(m); }catch(e){ it.stock = est; }
      }

      saveDB(); refreshAll(); toast("Item atualizado.");
      return;
    }

    const it = {
      id: uid(),
      code, desc, category:cat, unit,
      stock: 0,
      minStock: min,
      avgCost: (cost>0? +cost.toFixed(6) : 0),
      lastCost: (cost>0? +cost.toFixed(6) : 0),
      suggestSell: vendaSug,
      obs
    };
    DB.items.push(it);

    if(est>0 && cost>0){
      const m = { id: uid(), at: nowISO(), type:"ENTRADA", itemId: it.id, qty: est, priceBuy: cost, priceSell: 0, reason:"ESTOQUE INICIAL", obs };
      applyMove(m); DB.moves.push(m);
    }else{
      it.stock = est;
    }

    saveDB(); refreshAll(); toast("Item salvo."); clearItemForm();
  };

  function refreshItensTable(){
    const tb=document.querySelector("#tblItens tbody");
    tb.innerHTML="";
    const q=(iBusca.value||"").trim().toLowerCase();
    const items=[...DB.items]
      .filter(it=>{
        if(!q) return true;
        return (`${it.code} ${it.desc} ${it.category}`).toLowerCase().includes(q);
      })
      .sort((a,b)=>(a.code||"").localeCompare(b.code||""));

    if(items.length===0){
      const tr=document.createElement("tr");
      tr.innerHTML=`<td colspan="10" class="muted" style="padding:14px">Nenhum item.</td>`;
      tb.appendChild(tr);
      return;
    }

    for(const it of items){
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td><b>${esc(it.code)}</b></td>
        <td>${esc(it.desc)}</td>
        <td class="muted">${esc(it.category||"—")}</td>
        <td class="muted">${esc(it.unit||"UN")}</td>
        <td style="text-align:right"><b>${Math.round(num(it.stock)).toLocaleString("pt-BR")}</b></td>
        <td style="text-align:right" class="muted">${Math.round(num(it.minStock)).toLocaleString("pt-BR")}</td>
        <td style="text-align:right">${money.format(num(it.avgCost))}</td>
        <td style="text-align:right"><b>${money.format(num(it.suggestSell))}</b></td>
        <td>${status(it)}</td>
        <td>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn info" data-ent="${it.id}">Entrada</button>
            <button class="btn warn" data-sai="${it.id}">Saída</button>
            <button class="btn" data-edit="${it.id}">Editar</button>
            <button class="btn danger" data-del="${it.id}">Excluir</button>
          </div>
        </td>
      `;
      tb.appendChild(tr);
    }

    tb.querySelectorAll("[data-edit]").forEach(b=>{
      b.onclick=()=>{
        const it = DB.items.find(x=>x.id===b.dataset.edit);
        if(!it) return;
        editItemId=it.id;
        document.getElementById("iCodigo").value=it.code||"";
        document.getElementById("iDesc").value=it.desc||"";
        document.getElementById("iCat").value=it.category||"";
        document.getElementById("iUn").value=it.unit||"UN";
        document.getElementById("iCusto").value=(num(it.lastCost||it.avgCost)||0).toFixed(2);
        document.getElementById("iVendaSug").value=(num(it.suggestSell)||0).toFixed(2);
        document.getElementById("iEst").value=Math.round(num(it.stock));
        document.getElementById("iMin").value=Math.round(num(it.minStock));
        document.getElementById("iObs").value=it.obs||"";
        toast("Item carregado.");
        setTab("itens");
      };
    });

    tb.querySelectorAll("[data-del]").forEach(b=>{
      b.onclick=()=>{
        const it = DB.items.find(x=>x.id===b.dataset.del);
        if(!it) return;
        if(!confirm(`Excluir ${it.code}? Isso remove o histórico desse item.`)) return;
        DB.items = DB.items.filter(x=>x.id!==it.id);
        DB.moves = DB.moves.filter(m=>m.itemId!==it.id);
        if(editItemId===it.id) clearItemForm();
        saveDB(); refreshAll(); toast("Excluído.");
      };
    });

    tb.querySelectorAll("[data-ent]").forEach(b=> b.onclick=()=> openMovModal(b.dataset.ent, "ENTRADA"));
    tb.querySelectorAll("[data-sai]").forEach(b=> b.onclick=()=> openMovModal(b.dataset.sai, "SAIDA"));
  }
  iBusca.addEventListener("input", refreshItensTable);

  // Modal Entrada/Saída
  const modalMov = document.getElementById("modalMov");
  const mTitle = document.getElementById("mTitle");
  const mSub = document.getElementById("mSub");
  const mTipo = document.getElementById("mTipo");
  const mQtd = document.getElementById("mQtd");
  const mPreco = document.getElementById("mPreco");
  const mPrecoBox = document.getElementById("mPrecoBox");
  const mObs = document.getElementById("mObs");
  const mPreview = document.getElementById("mPreview");

  function openMovModal(itemId, tipo){
    const it = DB.items.find(x=>x.id===itemId);
    if(!it) return;
    MODAL_ITEM_ID = itemId;

    mTipo.value = tipo;
    mQtd.value = 1;
    mPreco.value = (num(it.lastCost||it.avgCost)||0).toFixed(2);
    mObs.value = "";

    mTitle.textContent = `Movimentação — ${it.code}`;
    mSub.textContent = `${it.desc} • Estoque: ${Math.round(num(it.stock))} • CM: ${money.format(num(it.avgCost))}`;

    updateMovPreview();
    modalMov.classList.add("show");
    mQtd.focus();
  }
  function closeMovModal(){
    modalMov.classList.remove("show");
    MODAL_ITEM_ID = null;
  }
  function updateMovPreview(){
    const it = DB.items.find(x=>x.id===MODAL_ITEM_ID);
    if(!it){ mPreview.textContent="—"; return; }
    const tipo = mTipo.value;
    const q = Math.round(num(mQtd.value));
    const est = Math.round(num(it.stock));

    if(tipo==="ENTRADA"){
      mPrecoBox.style.display="";
      const p = num(mPreco.value);
      mPreview.textContent = `Vai ENTRAR ${q} un • Preço compra ${money.format(p)} • Estoque após: ${est + q}`;
    }else{
      mPrecoBox.style.display="none";
      const novo = est - q;
      mPreview.textContent = `Vai SAIR ${q} un • Estoque após: ${novo < 0 ? "INSUFICIENTE" : novo}`;
    }
  }

  document.getElementById("mClose").onclick = closeMovModal;
  document.getElementById("mCancel").onclick = closeMovModal;
  modalMov.addEventListener("click", (e)=>{ if(e.target===modalMov) closeMovModal(); });
  [mTipo,mQtd,mPreco].forEach(el=>{
    el.addEventListener("input", updateMovPreview);
    el.addEventListener("change", updateMovPreview);
  });

  document.getElementById("mSave").onclick = ()=>{
    const it = DB.items.find(x=>x.id===MODAL_ITEM_ID);
    if(!it) return;

    const tipo = mTipo.value;
    const q = Math.round(num(mQtd.value));
    if(!(q>0)){ toast("Qtd inválida."); return; }

    const move = {
      id: uid(),
      at: nowISO(),
      type: tipo,
      itemId: it.id,
      qty: q,
      priceBuy: (tipo==="ENTRADA") ? num(mPreco.value) : 0,
      priceSell: 0,
      reason: (tipo==="ENTRADA") ? "ENTRADA" : "SAIDA",
      obs: (mObs.value||"").trim()
    };

    try{
      applyMove(move);
      DB.moves.push(move);
      saveDB();
      refreshAll();
      closeMovModal();
      toast("Movimentação salva.");
    }catch(e){
      toast(e.message || "Erro ao salvar.");
    }
  };

  // Histórico
  const hBusca=document.getElementById("hBusca");
  function refreshHist(){
    const tb=document.querySelector("#tblHist tbody");
    tb.innerHTML="";
    const q=(hBusca.value||"").trim().toLowerCase();

    const moves=[...DB.moves].sort((a,b)=>(b.at||"").localeCompare(a.at||""))
      .filter(m=>{
        if(!q) return true;
        const it=DB.items.find(x=>x.id===m.itemId);
        const text = `${m.type} ${it?.code||""} ${it?.desc||""} ${m.reason||""} ${m.obs||""}`.toLowerCase();
        return text.includes(q);
      });

    if(moves.length===0){
      const tr=document.createElement("tr");
      tr.innerHTML=`<td colspan="10" class="muted" style="padding:14px">Sem movimentações.</td>`;
      tb.appendChild(tr);
      return;
    }

    for(const m of moves){
      const it=DB.items.find(x=>x.id===m.itemId);
      const qty = Math.round(num(m.qty));
      const buyUnit = (m.type==="ENTRADA") ? num(m.priceBuy) : 0;
      const sellUnit = (m.type==="VENDA") ? num(m.priceSell) : 0;

      const custo = (m.type==="ENTRADA") ? (qty*buyUnit) : (qty * num(it?.avgCost));
      const venda = (m.type==="VENDA") ? (qty*sellUnit) : 0;
      const lucro = (m.type==="VENDA") ? (venda - (qty * num(it?.avgCost))) : 0;

      const tipoPill = m.type==="ENTRADA"
        ? `<span class="pill ok">ENTRADA</span>`
        : (m.type==="VENDA"
            ? `<span class="pill info">VENDA</span>`
            : `<span class="pill warn">SAÍDA</span>`);

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td class="muted">${toLocal(m.at)}</td>
        <td>${tipoPill}</td>
        <td><b>${esc(it?.code||"—")}</b> <span class="muted">— ${esc(it?.desc||"—")}</span></td>
        <td style="text-align:right"><b>${qty.toLocaleString("pt-BR")}</b></td>
        <td style="text-align:right">${m.type==="ENTRADA" ? money.format(buyUnit) : "<span class='muted'>—</span>"}</td>
        <td style="text-align:right">${m.type==="VENDA" ? money.format(sellUnit) : "<span class='muted'>—</span>"}</td>
        <td style="text-align:right">${money.format(custo)}</td>
        <td style="text-align:right">${m.type==="VENDA" ? `<b>${money.format(lucro)}</b>` : "<span class='muted'>—</span>"}</td>
        <td>${esc(m.reason||"—")}</td>
        <td class="muted">${esc(m.obs||"")}</td>
      `;
      tb.appendChild(tr);
    }
  }
  hBusca.addEventListener("input", refreshHist);

  document.getElementById("btnCsv").onclick=()=>{
    const header=["data_hora","tipo","codigo","descricao","qtd","preco_compra_unit","preco_venda_unit","total_custo","total_venda","lucro","motivo","obs"];
    const rows = [...DB.moves].sort((a,b)=>(b.at||"").localeCompare(a.at||"")).map(m=>{
      const it=DB.items.find(x=>x.id===m.itemId);
      const qty = Math.round(num(m.qty));
      const buyUnit = (m.type==="ENTRADA") ? num(m.priceBuy) : "";
      const sellUnit = (m.type==="VENDA") ? num(m.priceSell) : "";

      const totalCusto = (m.type==="ENTRADA") ? (qty*num(m.priceBuy)) : (qty*num(it?.avgCost));
      const totalVenda = (m.type==="VENDA") ? (qty*num(m.priceSell)) : "";
      const lucro = (m.type==="VENDA") ? ((qty*num(m.priceSell)) - (qty*num(it?.avgCost))) : "";

      return [toLocal(m.at), m.type, it?.code||"", it?.desc||"", qty, buyUnit, sellUnit, totalCusto, totalVenda, lucro, m.reason||"", m.obs||""];
    });

    const escCSV = (v)=>{
      const s=String(v??"");
      return /[",\n;]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    };
    const csv = [header, ...rows].map(r=>r.map(escCSV).join(";")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download="ampertech_historico.csv";
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),800);
    toast("CSV baixado.");
  };

  document.getElementById("btnReset").onclick=()=>{
    if(!confirm("Apagar tudo (itens + histórico)?")) return;
    localStorage.removeItem(LS_KEY);
    DB={items:[], moves:[]};
    CART=[];
    clearItemForm();
    refreshAll();
    refreshCart();
    toast("Dados apagados.");
  };

  function refreshAll(){
    refreshItensTable();
    refreshHist();
    refreshVendaSelect();
    rebuildDatalist();
  }

  // init
  clearItemForm();
  refreshAll();
  refreshCart();
  setTab("venda");
  vBuscaProduto.focus();
</script>
</body>
</html>
